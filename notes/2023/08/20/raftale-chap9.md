## 线型一致性

在一个线性一致的系统中，只要一个客户端成功完成写操作，所有客户端从数据库中读取数据必须能够看到刚刚写入的值。要维护数据的单个副本的 假象，系统应保证读到的值始终是最新的，而不是陈旧的缓存或者副本或不存在该值的情况。换句话说，线性一致性是一个**新鲜度**保证（recency guarantee）。

> 事实上，线性一致性最开始是关于并发对象行为正确性的一个模型，
>
> 现代多核CPU体系中，每个cpu核都有自己的内存缓存（memory cache）和存储缓冲区（store buffer），默认情况下，内存访问首先走cache，任何变更会**异步**写入主存，但每个cpu核中的cache中可能有一个共享变量的副本，多线程的场景下，就可能存在缓存不一致的问题。
>
> 解决缓存一致性的思想是：当cpu要更新cache中的某个数据时，不能直接修改，而是先向其他所有的cpu核心广播一个请求，要求先把该数据对应的cache line标记为「无效状态」，得到确认后，然后再更新当前Cache里面的数据，最后再写入主存中。当产生读取时，发现无效的状态就会从主存中读取。注意这里是先广播得到确认再修改，如果是先修改再广播，可能出现线程A和线程B都同时修改后再广播，线程A和线程B往主存中写就会产生冲突，同时对于两个读的线程C和线程D来说，它们看到的变量变化可能是相反的情况。
>
> 还有，当一个变量正在被一个线程写的时候，需要保证之前读的线程完成读操作，写中途进来的读操作应该读到的是最新值，写中途进来的写操作不应该干扰当前写（否则还是会发生冲突）。为了这些保证，还需要用到内存屏障（Memory Barrier），写入某个变量之前，之前发生的读或写操作必须已经完成（独占锁）。一旦完成写入，任何访问这个变量的线程都会得到最新值；所有为了保证换成一致性，
>
> 上面说的其实是MESI协议，它在硬件层面保证了并发写写、读写的可见性和原子性（其实可以理解为串行执行），这可以看作并发对象的线性一致性，但这并不是cpu默认的工作方式，每次都使用MESI协议来更新值是有性能损耗的，所以这个协议向上提供给了操作系统，Java基于此实现了votatile。



分布式系统的线性一致性可以类比并发对象的线性一致性，同一个对象相当于同一个变量，多个节点相当于多个cpu核。

但分布式系统中的线性一致性有自己的一套非严格定义和严格定义，我想还是不能完全等价的。

线性一致性也称为原子一致性、强一致性、immediate consistency、external consitency，CAP定理中的一致性就是指的线性一致性。最基本的假设就是 整个系统看起来只有一个副本，并且每个操作都是原子性的。

好文：

1. https://bbs.huaweicloud.com/blogs/344101
2. https://www.cnblogs.com/dojo-lzz/p/16183006.html





### What makes a system linearizable?

上面我们讲到了从整个分布式系统来看，线性一致性的概念应该是怎样的。但对具体的对象的多个节点的一连串读写来看，什么样的行为才是满足线性一致性，这一小章将进行讲解。

对比单机的并发对象保证线性一致性的读写屏障，分布式系统中，读写都是客户端发起的，显然你不能去控制客户端发起请求的时间。客户端一个完整的读写是由发起请求、执行、返回响应组成的，如果如果真的要控制，那也是在执行时刻，返回时刻也是没办法控制的（因为网络延迟可变不可控）。

如果多个客户端（准确来说是多个线程）发起了一连串的请求 读写某个对象，那么在一个全局的上帝视角来看，这些请求最后的表现是否是线性一致性的，它必然要满足一些特征：

1. 写操作：写入请求开始，执行写入完成，响应完成。

1. 1. 与写操作在时间上重叠的任何读操作，都可以认为是并发的，既然是并发的，单个读取返回旧值和新值都是可以的；
   2. 与写操作在时间上重叠的任何写操作，都可以认为是并发的，既然是并发的，写入哪个值。

1. 但任何一个写入响应完成后，后续的读都必须返回新值。
2. 同时任何一个读取返回新值后，所有后续读取（包括其他客户端）也必须返回新值。

只有当整个过程下来，对这个对象的所有读写能够在全局时钟下找到一个有效的排列顺序，那这个系统就是线性一致的，直到不满足。这也是线性一致性的严格定义。

为什么有这样的定义，也许是因为从一个节点到另一个节点到响应到达时间是不可控的，不同的响应到达时间就可能很容易的破坏一致性。而在单机下的cpu并发中，响应的返回是确定的，单机下能很容易的判断出来。所以从观察者的角度来看，如果你要测量一个分布式系统是否能满足前面提到的线性一致性，那就要记录下所有请求和响应的时间，然后检查他们是否可以组成有效的排列，来测试一个系统的行为是否是线性一致性。
