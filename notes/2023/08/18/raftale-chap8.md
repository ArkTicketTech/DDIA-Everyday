## 知识、真相和谎言



分布式系统没有共享内存，只有通过可变延迟的不可靠网络传递的消息，系统可能遭受部分失效，不可靠的时钟和进程暂停。

分布式系统的主要讨论点在，我们可以陈述关于行为的各种假设，并以这些假设的方式设计实际系统，提供我们希望的系统保证。

### 真相由多数所定义

分布式系统不能完全依赖单个节点，因为节点可能随时失效，可能会使系统卡死，无法恢复。许多分布式算法都依赖于法定人数，即在节点之间进行投票：决策需要来自多个节点的最小投票数，以减少对于某个特定节点的依赖。

最常见的法定人数是超过系统的一半的绝对多数。分布式系统中，多数只有一个，不可能存在两个相互冲突的多数决定。



#### 领导者和锁

有时候，一些东西在系统中只能由一个，例如：

1. 数据库分区的领导者只能有一个节点，以避免脑裂；
2. 特定资源的锁 或对象只允许一个事务/客户端持有，以防止同时写入和损坏；
3. 一个特定用户名只能由一个用户注册，因为用户名是唯一标识；



分布式系统中，始终要记住只有法定人数的节点的同意才是有效的。一个节点开始是领导者（the choonse one，分区的负责人，锁的持有者等），但由于进程暂停至租约过期，暂停期间，有新的领导者被法定人数推选出来。

但之前讲到会出现一个问题，待进程恢复后，还有没有处理完的请求，如果这个请求向其他节点发送消息，其他节点相信这个消息的话，整个系统可能会不正确。

比如它代表客户端1要做一个写入文件的动作，但新的领导者在它之前已经由客户端2写入数据，进程恢复后再写入会导致文件的损坏（假设该文件一次只能被一个客户写入）。

#### 防护令牌

当使用锁或者租约来对某些资源进行访问时，需要确保一个被误认为是the choosen one的节点不能扰乱系统，确保的方法很简单，就是版本号。

每次锁定服务器赋予锁或者租约时，它还会返回一个防护令牌（fencing token），每次授予锁定时令牌号都会加1。我们可以要求客户端每次向存储服务写入请求时，都必须包含当前的防护令牌。存储服务会拒绝掉低版本的防护令牌的写入。



### 拜占庭故障

防护令牌可以检测和阻止无意中发生错误的节点，但是如果有恶意的节点，他总是可能伪造数据，则可以通过假的防护令牌骗过系统。之前我们都是假设节点是诚实的，但如果节点存在说谎（发送任意错误或损坏的响应）的可能性，分布式系统会变得更加困难。

一个节点没有收到某条信息却声称收到了，这种行为称为拜占庭故障（Byzantine fault)。在具有拜占庭故障的环境中达成共识也被称为拜占庭将军问题（Byzatine Generals Problem）。

如果有一些节点发生故障且不遵守协议，或者恶意攻击扰乱网络，该系统仍能正常运行，则该系统是拜占庭容错的。比如：

1. 航天领域，由于高辐射环境的存在，计算机内存或者寄存器中的数据可能会损坏，进而以任意不可预料的方式响应其他节点的请求。在这种场景下，系统故障代价会非常高昂（如：太空飞船坠毁并致使所有承载人员死亡，或者火箭装上国际空间站），因此飞控系统必须容忍拜占庭故障。
2. p2p的网络中，恶意的节点会尝试作弊或者欺骗别人。在这种环境中，由于恶意消息发送方的存在，无脑的相信其他节点的消息是不安全的。如，类似比特币或者其他区块链的 p2p 网络，就是一种让没有互信基础的多方，在不依赖中央权威的情况下，就某个交易达成共识的一种方法。



在我们的数据中心，所有的节点都是受你所控制的，大多数服务端的数据系统中，使用拜占庭容错的解决方案成本都非常高，不现实，也没有必要。



#### 弱谎言

即使我们假设节点都是诚实的，但为软件加上一些简单的防护机制能避免出错的客户端。

1. 应用层的字段校验过滤掉网络中损坏的数据包；
2. 仔细过滤来自用户的任何输入，如检查输入值是否在合理的范围内、限制字符串长度，以避免过量内存分配造成的拒绝服务攻击
3. 可以为 NTP 客户端配置**多个 NTP 服务源**。当进行时钟同步时，客户端会向所有源发送请求，估算误差，以判断是否绝大多数源提供的时间会落在同一个时间窗口内。只要大部分 NTP 服务器正常运行，一两个提供错误时间的 NTP 服务器就会被检测出来，并被排除在外。从而，使用多个服务器让 NTP 同步比使用单个服务器更加鲁棒。

###   系统模型和现实

在设计算法的时候，不能过重的依赖硬件的细节和软件的配置，这迫使我们对系统中可能遇到的问题进行**抽象化处理**

时序假设有三种系统模型：

1. 同步模型：这种模型假设网络延迟、进程停顿和时钟错误都是有一个上界的，但这不是一个现实的模型，因为现实中，无界的延迟和停顿都是有可能发生的；
2. 部分同步模型：这种模型假设大多数时候，网络延迟、进程停顿和时钟错误都是有一个上界的，只是偶尔，它们会超越上界。这是一种比较真实的模型，我们要做好最坏的打算。
3. 异步模型：没有时序的概念。



节点系统模型：

1. 崩溃-停止故障
2. 崩溃-恢复故障
3. 拜占庭故障

对于真实系统的建模，具有 **崩溃 - 恢复故障（crash-recovery）** 的 **部分同步模型（partial synchronous）** 通常是最有用的模型。

#### 算法的正确性

算法的正确性需要定义，我们可以通过描述算法需要满足的性质。比如我们想通过防护令牌来上锁，则我们期望算法有以下性质

1. 唯一性：没有两个防护令牌请求返回相同的值
2. 单调有序性：请求令牌的先后决定了令牌的大小
3. 可用性：请求防护令牌并且不会崩溃的节点，最终会收到响应



#### 安全性和活性

安全属性（safety）：如果违反了安全性，就一定可以找到一个其被破坏的具体时间点。一旦违反了安全性，造成的损失已经发生，是不能撤销的。

活性（liveness）：：在某个时间点（例如，一个节点可能发送了一个请求，但还没有收到响应），它可能不成立，但总是希望在未来能成立（即通过接受答复）



区分安全性和活性的意义是： 我们可以处理困难的系统模型。

对于分布式算法，在系统模型的所有可能情况下，要求始终保持安全属性是常见的，也就是说，即使所有节点崩溃，或者整个网络出问题，算法仍然必须确保它不会返回错误的结果；

活性属性：只有在大多数节点没有崩溃的情况下，只有当网络最终从中断中恢复时，我们才可以说请求需要接收响应

#### 将系统模型映射到现实世界

系统模型不能完全覆盖现实的方方面面，比如：

1. 崩溃-恢复的节点硬件损坏；
2. 法定人数算法依赖节点来记住它声称存储的数据，如果一个节点忘记了之前存储的数据，这会打破法定人数。
3. 计算机中不可预料的故障；

 但这并不意味者模型没有意义，恰恰相反，它们将实际系统的复杂性提取成一个一个可以推理的可处理的错误类型，以便我们能够理解这个问题，并试图系统的解决这个问题。理论分析与经验测试同样重要



## 本章小结

不可靠的网络、不可靠的时钟、进程暂停 导致的部分失效问题，提示者我们在分布式系统中建立部分失效的容错机制，这样即使部分系统的某些组成部分被破坏的情况下，也能正常运行。

如何检测故障的节点：超时。

容忍故障：法定人数 等共识协议
