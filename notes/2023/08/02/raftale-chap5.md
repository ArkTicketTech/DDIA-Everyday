## 无主复制是什么
没有所谓的主库，客户端的写入是多个协调者节点负责，协调者不执行特定的写入顺序。
协调者节点写入数据时，会带上版本号。
客户端读数据的时候会从多个节点读，选取版本号最新的哪一个数据返回给客户端。

## 如何确定写入和读取的节点
我们的基本原则必然是写入可靠，读取准确无误。
假设共有n个副本， 每次写入需要个副本，读取需要r个副本，
每次写入后有剩余 n - w 个节点，这些节点存储的还是旧值，为了读取到新值，我们必须保证 r > n - w，所以当w + r > n时，能保证读取到新值。满足这一条件的w和r称为法定人数（quorum）

Dynamo 是Amazon的一个无主复制的数据库，在 Dynamo 风格中，w = r = ceil((n+1)/2)
实际上可以根据具体情况，来对w和r的值进行选择：
w越小，写入越快，读取越慢；r越小，读取越快，写入越慢
甚至不必保证每次都能读取到新值，配置w + r <= n，可以对性能有更大的提升，因为更少的写入节点和读取节点响应更快。
### 法定人数一致性的局限性
但即使满足了w + r > n，也可能存在问题：
1. 如果两个写入同时发生，唯一安全的解决方案是合并并发写入。如果根据时间戳选出最终值，会有丢失数据的风险。
2. 如果写操作和读操作同时发生，写操作可能仅仅反映在某些副本上，不确定读取返回的是新值还是旧值。 - 其实感觉问题不大
3. 如果写操作在某些节点成功，某些节点失败，判定为失败，但是写入成功的节点并没有回滚数据。后续读取可能会读取这些失败的值。 - 所以为什么不回滚呢？算是分布式事务吗
4. 如果携带新值的节点发生故障，需要从其他带有旧值的副本进行恢复，就造成了新值的副本数低于w，打破法定人数条件
5. 其他问题。
### 监控陈旧度
有主复制的写入是按照相同的顺序应用于主库和从库，通过主库的当前位置减去从库的当前位置，可以测量复制延迟的程度。
但无主复制的系统中，没有固定的写入顺序，难以监控。
### 宽松的法定人数和提示移交
如果是一个大型集群，节点数量大于n个副本，比如20个节点，客户端A的数据会写入预订的9个副本（因为一个数据并不一定需要写入所有的节点），读写w和r都为5，达到了法定人数，现在因为网络中断，这9个副本挂了5个，那写入的副本就只有4个，达不到法定人数，此时要么返回错误，或者用20个节点中其余可以用的5个节点临时作为补充，此时w被认为是一个宽松的法定人数（sloppy quoroum)。
由于读取还是用的之前的9个副本，所以不能确保读取的正确性。
宽松的法定人数提高了可用性，完成了数据持久化的保证，但牺牲了一部份读的正确性。
一旦网络恢复，补充的节点会立即将数据复制到恢复的节点，同时写入也开始写入恢复的节点。
