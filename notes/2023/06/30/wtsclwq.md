## 分区和二级索引

分区都是通过主键来分，二级索引通常建立在非主键上，大概率没有唯一性约束，也就不能唯一的标识一条数据。

关系型数据库中二级索引很常见，但是在kv中却很难实现。在es中倒排索引也是二级索引。

可以用二级索引对数据库分区

### 基于文档

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig6-4.png" alt="img" style="zoom:50%;" />

所谓基于文档分区，也就是基于二级索引的文档id分区，每个分区中存的文档都不同，根据关键词搜索时，在每个分区走**倒排索引(二级索引)**会找到具体的文档id，然后在分区内根据文档id的**主键索引**查找具体的文档。

每个分区完全独立，各自维护二级索引和主键索引，无论何时写入数据库，只需要在分区内修改具体的文档和索引即可，因此**基于文档分区索引又称本地索引**。

### 基于关键词

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig6-5.png" alt="img" style="zoom:50%;" />

基于二级索引的关键词进行分区，没太看懂怎么建立的

## 分区再均衡

可能会有增加/减少机器的需求，因为数据量不断增加/减少

一些要求：

- 再平衡之后，负载应该是公平的
- 不能暂停读写
- 避免不必要的数据移动，因为磁盘和网络IO是的开销很大

### 反面教材：Hash Mod N

为什么我们在分区策略中不能采用Hash Mod N的策略？

因为采用这种方式，再平衡的时候，虽然只需要改变N的大小，但是会造成大量的数据移动

### 固定数量的逻辑分区

**一定要区分逻辑分区和物理节点**

创建比节点更多的分区，并为每个节点分配多个分区。

> 例如，运行在 10 个节点的集群上的数据库可能会从一开始就被拆分为 1,000 个分区，因此大约有 100 个分区被分配给每个节点。

此时如果要添加一个节点，新节点就可以从之前的集群中被分配一些分区，只有分区在节点之前移动，而分区的数量不会改变，key->分区的映射也不需要修改

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig6-6.png" alt="img" style="zoom:50%;" />

> 这种变更并不是即时的 — 在网络上传输大量的数据需要一些时间 — 所以在传输过程中，原有分区仍然会接受读写操作。
