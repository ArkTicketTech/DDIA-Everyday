## 故障与部分失效

单机软件没有根本性的不可靠原因，在于

1. 当硬件正常工作时，相同的操作总是产生相同的结果；
2. 如果存在硬件问题，通常是整个系统故障，软件的功能要么功能完好，要么完全失效；



而在分布式系统中，系统的某些部分节点崩溃是不确定性的，部分未失效的系统仍然可以工作，但这使得整个系统变得不可预测。

### 云计算与超级计算机

大型计算系统一般分为以下：

1. 高性能计算（HPC）系统，具有数千个CPU的超级计算机通常用于计算密集型科学计算任务，如天气预报核分子动力学；
2. 云计算
3. 传统企业数据中心位于这两个极端之间

HPC虽然看起来是一个大型的集群，但它对故障的处理几乎跟单机一样，如果一个节点出现故障，通常是停止整个集群，修复后从上一个检查点重新开始。



而实现互联网服务的系统中，与HPC很大的区别是：

1. 应用程序都是online的，服务不可用是不可接受的；
2. 云服务的节点成本低，故障率高；
3. 大型数据中心网络通常基于IP和以太网，以 CLOS 拓扑排列，以提供更高的对分（bisection）带宽。
4. 系统越大，单节点就越有可能坏掉，随着时间的推移，坏掉的东西得到修复，新的东西又坏掉；
5. 如果系统可以容忍发生故障的节点，并继续保持整体工作状态，那么这对于运维非常有好处：如滚动升级，一次重新启动一个节点，同时继续给用户提供不中断的服务。
6. 分布式系统很可能是异地分布的，保持数据在地理位置上解决用户减少访问延迟，通信很可能通过互联网进行，与本地网络相比，通信速度缓慢且不可靠。

如果要使分布式系统工作，就必须接受部分故障的可能性，并在软件中建立容错机制。换句话说，我们需要从不可靠的组件中构建一个可靠的系统。

故障处理是分布式系统必须要考虑的一部分。



## 不可靠的网络

本书中关注的分布式系统是无共享的系统，即通过网络连接的一堆机器。网络是这些机器可以通信的唯一途径 ，每台机器都有自己的内存和磁盘，一台机器不能访问另一台机器的内存或磁盘（除了通过网络向服务器发出请求）。无共享的优势是组件相对便宜，通过冗余实现高可靠性。

一个节点向另一个节点发送消息（一个数据包），但是网络不能保证它什么时候到达，或者是否到达。出错的可能性非常高：

1. 请求丢失（网线松动）
2. 请求阻塞（网络或接收方过载）
3. 远程节点可能已经失效（崩溃或者关机）
4. 远程节点暂时停止了响应（GC）
5. 远程节点可能已经处理了请求，但是网络上的延迟已经丢失；
6. 远程节点可能已经处理了请求，但是响应已经被延迟，并且稍后将被传递（网络或你自己的机器过载）

如果发送请求没有响应，无法区分 请求是否丢失、远程节点是否关闭、响应是否丢失。

发送者甚至不能分辨数据包是否被发送，发送方只能等待超时：在一段时间之后放弃等待，并且认为响应不会到达。



### 真是世界的网络故障

真是世界的网络故障是常见的、不可避免的，我们设计分布式系统时需要将网络故障和网络恢复后的情况都考虑在内。

 

### 故障检测

自动检测故障的必要性：

1. 负载均衡器需要停止向已死亡的节点转发请求；
2. 单主复制的分布式数据库中，如果主库失效，需要将从库之一升级为新的主库；

判定一个节点死亡的根据：响应发生明确的错误，或是请求响应超时，重试几次后依然超时。
