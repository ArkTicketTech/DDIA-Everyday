## 无主复制

单主和多主的思想都是：客户端向主库发送写请求，主库决定写入的顺序并将相同顺序的写操作同步给其他节点

而无主复制顾名思义就是没有主库，客户端直接将写入操作发送到每个节点。

### 写入时，有节点故障

![](https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig5-10.png)

只要写入成功的节点数量满足法定人数，就认为此次写入成功，忽略故障节点。

而读取时，由于之前的节点故障，可能读取到错误值，因此客户端会读取所有节点，并选择版本号更高的答案

### 读时修复和反熵

之前故障的节点什么时候恢复呢？

1. 读取时，发现从节点3读到的数据和法定人数的答案不同，更新他
2. 运行一个后台进程，和所有节点通信，对比结果，有节点发生错误就修复。

读时修复可能并不能完全覆盖错误，因此如果没有实现返熵的话，会降低持久性

### 法定人数

总共N个节点，写入W个节点算作成功，每次读取R个节点，如果R+W>N，那么读取操作必定能够读取到最新值。

比如总共5个节点ABCDE，每次写入3个节点算成功，如果每次只读取2个节点。

如果此时DC故障，而新的写入操作写入了ABC节点。

有可能每次读取到的都是故障的2个节点DE，而读取3个的话，能保证肯定读取到一个被写入最新值的节点。

这三个数都是可配置的，常见配置：

N为奇数，W=R=(N+1)/2（向上取整）

> 集群中可能有多于 n 个的节点（集群的机器数可能多于副本数目）。但是任何给定的值只能存储在 n 个节点上。这允许对数据集进行分区，从而可以支持比单个节点的存储能力更大的数据集。
>
> 因为复制只是提供了容错能力，分区才能提高吞吐量，参考muilt-raft，每个raft-group中有n个节点（副本）

![](https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig5-11.png)

### 法定人数的局限性
