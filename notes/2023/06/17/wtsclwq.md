### 问题2 时光倒流

看图：

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/image-20230618105048324.png" alt="image-20230618105048324" style="zoom:33%;" />

时刻1：User1234向集群插入一条评论A

时刻2：User2345向Follower1查询评论，此时Leader已经将A复制到了Follower1，因此User2345查询到了A

时刻3：User2345向Follower2查询评论，此时A还没有被复制到Follower2，因此User2345没有查到A

这就造成了User2345两次查询的结果不一样，类似**时光倒流**一样，A先出现了又消失了

**为什么会发生这个问题：**

依旧是异步复制

**如何解决：**

单调读机制（Monotonic reads）

**如何实现**：

1. 每个用户固定从一个节点读取（用Hash）
2. 时间戳：在某个节点读取时，检查该记录被修改的时间戳，和自己上一次读取该记录的时间戳

**单调读 VS 读写一致性**：

> 写后读保证的是写后读顺序，单调读保证的是**多次读**之间的顺序。

### 问题3 违反因果关系

看图：

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/ch05-fig05.png" style="zoom:33%;" />

假设目前集群由两个分区组成，观察者会不断的从两个分区中监听消息

时刻1：Poons向分区1的Leader写入问题

时刻2：Cake从分区1中读取到问题，并且向分区2的Leader写入回答

时刻3：观察者从分区2中读到了回答

时刻4：观察者从分区1中读到了问题

**为什么会发生这种问题：**

两个分区的同步速度不一致，分区1中直到时刻3之后才同步完成，而分区2中在时刻2之后不久就同步完成了

> 如果有因果关系的两个事件落在了不同分区，则有可能会出现**果在前，因在后**。

**怎么解决：**

一致前缀读（consistent frefix reads）

**怎么实现**：

1. 不分区
2. 确保任何因果相关的写入都写入相同的分区

**什么是分区？**

可以对比muilt raft：

分区1和2可能由不同的raft group维护，而raft group内部日志复制的速度不一致。
