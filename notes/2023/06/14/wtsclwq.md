#### 传输WAL

很多数据库和存储系统都实现了WAL，WAL日志文件中包含了所有的，对数据库做更改的操作，并且是append only的。那么状态复制就可以利用WAL，通过重放数据库或者存储系统的WAL日志来做到状态一致。

PG和oracle中WAL中存储的内容非常细节：

> WAL 包含哪些磁盘块中的哪些字节发生了更改。

如果数据库因为版本升级，改变了文件的组织方式，那么如果Leader和Follower的数据库版本不一致，WAL就不能做到状态同步了。

一个非常重要的问题，完全没想到：

> 如果复制协议允许从库使用比主库更新的软件版本，则可以先升级从库，然后执行故障切换，使升级后的节点之一成为新的主库，从而允许数据库软件的零停机升级。如果复制协议不允许版本不匹配（传输 WAL 经常出现这种情况），则此类升级需要停机。

### 基于行的复制

以上两种方式都过于保守，一个是原封不动的转发语句，一个是原封不动的转发节点上数据系统的WAL。其实我们可以将节点上数据系统的状态和要同步的内容分离开。

> 这种复制日志被称为逻辑日志（logical log），以将其与存储引擎的（物理）数据表示区分开来。

以关系数据库为例：

1. insert：日志中就存储新增的tuple
2. delete：日志中存储要删除tuple的key
3. updae：日志中存储key和diff

如果再加上事务，日志中还要包含事务提交的标志，用来实现ACID

> 由于逻辑日志与存储引擎的内部实现是解耦的，系统可以更容易地做到向后兼容，从而使主库和从库能够运行不同版本的数据库软件，或者甚至不同的存储引擎。
