### 基于承诺的系统，详解2PC

1. 协调者生成一个全局唯一的事务ID
2. 将带着该ID对应的事务发送给所有的参与者，让他们执行其中的读写操作，
3. 等待事务的执行结果：（1）所有人成功，进入下一步（2）有任何一个abort或者超时，协调者给所有参与者发一个回滚的命令
4. 协调者向所有参与者发送一个**准备提交**的询问
5. 当参与者收到**准备提交**请求时，它必须确认该事务能够在任何情况下都能被提交，才能回复“**可以**”
6. 当协调者收到所有参与者准备提交的回复后，会决定提交还是中止该事务
7. 协调者将决策刷入了磁盘后，就会将决策（提交或者中止）请求发给所有参与方。

### 协调者故障

> 如果协调者在准备提交请求发送前故障，则参与者可以放心的中止事务。然而，一旦参与者收到准备提交请求，并且回复“可以”，则根据 2PC 设定，它**不能单方面的中止事务**——而必须等待协调者的提交或者中止请求。如果此时协调者宕机或者网络故障，则参与者只能**死等**。参与者事务的这种状态称为**存疑**（in doubt）或者**未定**（uncertain）。

![Untitled](https://wtsclwq.oss-cn-beijing.aliyuncs.com/ch09-fig10.png)

> 在 2PC 中，唯一使算法能够完成的方法就是等待协调者恢复。这也是为什么，协调者在给参与者发送提交或者中止消息时，需要先将该决策写入事务日志中

### 为什么这里的2PC和我之前看的不一样？

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/1090617-20190710222443794-591603727.jpg" alt="Ω" style="zoom:33%;" />

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/1090617-20190710222454275-1462865655.jpg" alt="img" style="zoom:33%;" />

