#### 协同编辑

现在非常常用的东西，飞书、金山、腾讯文档等等，还有各种画图软件，甚至ide都支持了。

当然这里面其实和数据库的关系不大，但是也可以和上面的离线客户端联系起来，因为都是多个Leader同时在向同一个状态机里面写入数据。解决冲突的方式可以简单粗暴：

1. 加锁，A写了B只能看
2. 不加锁，A和B同时写，将编辑看作原子操作

### 解决写冲突

#### 问题：

多主模型最大的问题就是写冲突，如果两个Leader被写入的不是同一个地方就万事大吉，直接合并即可，类似git，但是如果有下面这种情况：

> 用户 1 将页面的标题从 A 更改为 B，并且用户 2 同时将标题从 A 更改为 C。每个用户的更改已成功应用到其本地主库。

这时候两个Leader在同步的时候就会出现冲突

![img](https://wtsclwq.oss-cn-beijing.aliyuncs.com/fig5-7.png)

#### 冲突检测

在单Leader模型中，所有操作都被组织成一个日志序列，第二个操作只能在第一个操作提交后再提交，两个客户端会相继收到操作成功的响应。

但是在多主模型中，客户端都认为自己的操作成功了，但是在合并冲突时就会失去一次成功的提交或者得到错误的最终结果。

可以借鉴单Leader的做法，一个本地Leader只有在当前写入被同步到所有副本之后再响应客户端，但是这样就和单主模型没什么区别了，失去了多主的优势。

#### 冲突避免

将数据分区，不同分区的Leader处在不同的数据中心，这样对同一个分区的写入操作，就都会定向到同一个数据中心同一个Leader，完全不会影响其他分区的数据。就像git协作时，A组人只写前端，B组人只写后端，两组人的写入不会有冲突，冲突只在组内发生。
