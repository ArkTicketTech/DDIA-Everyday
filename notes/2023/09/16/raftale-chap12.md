### 及时性与完整性



一致性：

- 及时性：确保用户能立即观察到系统的最新状态；线性一致性是实现及时性的强有力方法，或者「写后读」这样弱的一致性也很有用。
- 完整性：意味着数据没有丢失，并且没有矛盾或错误的数据。完整性是永久的



完整性相对及时性来说更为重要。

#### 数据流系统的正确性

ACID事务通常既提供了及时性（线性一致性），也提供了完整性保证（原子提交）。

基于事件的数据流系统，及时性与完整性是分开的，在异步处理事件流不能保证及时性，完整性才是流处理系统的核心。

恰好一次是一种保持完整性的机制，容错消息传递（重试）和重复抑制（幂等）对于维护数据系统完整性非常重要。

可靠的流处理系统可以在无需分布式事务与原子提交协议的情况下保持完整性，这意味着流处理系统有潜力达到与分布式事务相当的正确性，同时还具备好得多的性能与运维稳健性，为了达成这种正确性，可以组合使用多种机制：

1. 将写入操作的内容变为单条消息 - 与时间溯源搭配效果拔群；
2. 使用确定性衍生函数，从这一消息中衍生出所有其他的状态变更；
3. 将客户端生成的请求ID传递所有的处理层次，从而允许端到端的去重，保持幂等性；
4. 使消息不可变，并允许衍生数据能够被重新处理，从错误中恢复更加容易。

这种机制组合是未来构建容错应用的一个非常有前景的方向。

#### 宽松地解释约束

执行唯一性约束需要共识，通常通过在单个节点中国呢汇集特定分区中的所有事件来实现，我们想要传统的唯一性约束形式，这种限制是不可避免的。

但是真实应用真的所有场景都需要这么严格吗？实际上很多都能接受弱得多的唯一性：

1. 两个人同时注册了相同的用户名或者预定了相同的座位，你可以给其中一个人发消息道歉，并要求他们进行一个更换，这种纠正错误的变化被称为补偿性事务；
2. 如果客户订购的商品多于仓库存储，你可以下单补仓，并为延误向客户道歉；一般情况，是你的仓库存储远远多于用户需求，根本不需要担心仓库存货，所以对仓库数目的校验也许可以去掉；
3. 还有航空空司会故意超卖机票，因为他们预测会有旅客错过航班，如果没有人放弃，就进入补偿流程。
4. 如果有人从账户中超额取款，银行可以向他们收取透支费用，并要求偿还欠款。通过限制每天都提款总额，银行的风险是可控的。

许多商业场景中，临时违背约束并稍后通过道歉来修复，只要成本允许是可以接受的。如果可以接受的话，在写入数据之前检查所有约束的传统模型反而带来不必要的限制，而线性一致性的约束也不是必须的。乐观写入，事后检查可能是一种合理的选择。你仍然可以在做一些挽回成本高昂的事情前确保有相关的验证，但这并不意味着写入数据之前必须先进行验证。

这些应用确实需要完整性：比如你不会希望丢失预定信息，或者资金消失，但他们执行约束时不需要考虑及时性。



#### 无协调数据系统

1. 数据流系统可以维持衍生数据的完整性保证，无需原子提交、线性一致性或者同步的跨分区协调；
2. 严格的唯一性约束要求及时性和协调，但许多应用实际上可以接受宽松的约束：只要整个过程保持完整性，这些约束可能会被临时违反并在稍后修复。

数据流系统可以为许多应用提供无需协调的数据管理服务，且仍能给出很强的完整性保证。无协调的数据系统比起同步协调的系统，有更好的性能和容错能力。

无协调的系统是指 多领导者配置，跨越多数据中心，在区域间进行异步复制。任何一种数据中心可以持续独立运行，不需要同步的跨区域协调。这样的系统及时性保证很弱，如果不引入协调它是不可能线性一致的。



为需求找到一个最佳平衡点很重要，既不需要太多一致性，又不存在太多可用性问题。

### 信任但验证

我们关于系统模型会面临很多可能软硬件的错误的假设是非常合理的，进程崩溃、机器断电、网络延迟、磁盘损坏、cpu异常都是现实中存在的。



#### 维护完整性，尽管软件有Bug

软件bug更常见，包括数据库本身，ACID意义下的一致性是在事务没有bug的情况下才成立。

#### 不要盲目信任承诺

检查数据完整性称为审计。

成熟的系统同样倾向于考虑不太可能的事情出错的可能性，并管理这种风险。

#### 验证的文化

可审计性也很重要。



像 HDFS 和 S3 这样的系统仍然需要假设磁盘大部分时间都能正常工作 —— 这是一个合理的假设，但与它们 **始终** 能正常工作的假设并不相同。然而目前还没有多少系统采用这种 “信任但是验证” 的方式来持续审计自己。许多人认为正确性保证是绝对的，并且没有为罕见的数据损坏的可能性做过准备。我希望未来能看到更多的 **自我验证（self-validating）** 或 **自我审计（self-auditing）** 系统，不断检查自己的完整性，而不是依赖盲目的信任【68】。

我担心 ACID 数据库的文化导致我们在盲目信任技术（如事务机制）的基础上开发应用，而忽视了这种过程中的任何可审计性。由于我们所信任的技术在大多数情况下工作得很好，通常会认为审计机制并不值得投资。

但随之而来的是，数据库的格局发生了变化：在 NoSQL 的旗帜下，更弱的一致性保证成为常态，更不成熟的存储技术越来越被广泛使用。但是由于审计机制还没有被开发出来，尽管这种方式越来越危险，我们仍不断在盲目信任的基础上构建应用。让我们想一想如何针对可审计性而设计吧。

#### 为可审计性而设计

事务一旦发生，很难知道这意味着什么，即使捕获了事务日志，也很难知道为什么会有这些变更。在发生bug时很难追溯。

但基于事件的系统可以提供更好的可审计行，具有确定性且定义良好的数据流，使得调试与跟踪系统的执行变得容易，比如事件溯源可以知道事件的来龙去脉。



#### 端到端原则重现

定期检查数据系统的完整性非常重要，最好是以端到端的方式进行。

持续的端到端完整性检查可以不断提高你对系统正确性的信心。

#### 

#### 用于可审计数据系统的工具



使用密码学工具来验证系统的完整性非常有趣，如加密货币。

实际上，它们就是分布式数据库，具有数据模型与事务机制，而不同副本可以由互不信任的组织托管，副本不断检查其他副本的完整性，并使用共识协议对应当执行的事务达成一致。

密码学审计与完整性通常依赖默克尔树，这是一颗散列值的树，能够用于高效地证明一条记录出现在一个数据集中。





## 做正确的事情

技术本身并无好坏之分，关键在于它们被如何使用，以及它如何影响人们。

### 预测性分析

预测性算法 发展到一定程度 就是有罪推断，而我们的司法系统 是无罪推断。

自动化系统可以系统地，任意地将一个人排出在社会参与之外，不需要任何有罪的证明，而且几乎没有申诉的机会。



#### 偏见与歧视



#### 责任与问责

预测系统的输出是概率性的，对于个例可能是错误的。



#### 反馈循环



### 隐私和追踪



#### 监视



#### 同意与选择的自由



#### 隐私与数据使用

监控成本因技术而变低。



#### 数据资产与权力

数据很有价值，但不属于用户

#### 回顾工业革命

数据是信息时代的污染问题，保护隐私是环境挑战。

#### 立法与自律





## 本章小结

1. 没有单种工具能满足所有复杂的需求，数据集成是主流；
2. 衍生系统来源于记录系统的转换；
3. 数据流表示为从一个数据集到另一个数据集到转换；
4. 数据流应用的概念：分拆数据库组件，并通过组合这些松散耦合的组件来构建应用程序；
5. 衍生状态通过CDC来更新，数据流可以用来构建动态更新；
6. 出现故障如何保证正确：可伸缩性的强完整性可以通过异步事件处理来实现，通过使用端到端操作标识来使操作幂等，以及通过异步检查约束。
7. 某些场景弱一致性可以接受，通过补偿事务（现实世界的活动）来保证数据完整性。
8. 数据流系统可以避免大多数的协调工作，无协调系统很有前景；
9. 数据隐私非常重要
