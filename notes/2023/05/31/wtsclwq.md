### B-Trees

B-Tree可以说是一个数据结构族，现在提到的话一般是指的B+Tree

>像SSTable 一 样, B-tree保留按键排序的key-value对, 这样可以实现高效的key-value查找和range查询。 但相似仅此而已: B-tree本质上具有非常不同的设计理念。

B-Tree将数据库分解成固定大小的块或者页，一般为4KB，是最小的读写单元，这么做主要是为了和Disk配合。

每个页面都可以使用地址或位置进行标识, 这样可以让 一 个页面引用另 一个页面, 类似指针, 不过是指向磁盘地址, 而不是内存，**某一页被指定为B-tree的根**，B-tree中一个页所包含的子页引用数觉称为分支因子，分支因素取决千存储页面引用和范围边界所需的空间总量, 通常为几百个。

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/image-20230601104354293.png" alt="image-20230601104354293" style="zoom:33%;" />

#### B-Tree的查找

每当查找索引中的 一个键时, 总是从根页面开始。 

该页面包含若干个键和对子页的引用。 每个孩子都负责 一个连续范围内的键, 相邻引用之间的键可以指示这些范围之间的边界。

#### B-Tree的更新

如果要更新B-tree中现有键的值, 首先搜索包含该键的叶子页, 更改该页的值, 并将页写回到磁盘(对该页的任何引用仍然有效) 。 

#### B-Tree的插入

找到其范围
包含新键的页, 并将其添加到该页。 如果页中没有足够的可用空间来容纳新键, 则将其分裂为两个半满的页, 并且父页也需要更新以包含分裂之后的新的键范围

<img src="https://wtsclwq.oss-cn-beijing.aliyuncs.com/image-20230601104654575.png" alt="image-20230601104654575" style="zoom:33%;" />

#### 维护B-Tree的可靠性


B 树不像 LSM-Tree，会在原地修改数据文件。

在树结构调整时，可能会级联修改很多 Page。比如叶子节点分裂后，就需要写入两个新的叶子节点，和一个父节点（更新叶子指针）。

1. 增加预写日志（WAL），将所有修改操作记录下来，预防宕机时中断树结构调整而产生的混乱现场。
2. 使用 latch 对树结构进行并发控制。

#### 优化B-Tree

1. 不使用 WAL，而在写入时利用 Copy On Write 技术。同时，也方便了并发控制。如 LMDB、BoltDB。
2. 对中间节点的 Key 做压缩，保留足够的路由信息即可。以此，可以节省空间，增大分支因子。
3. 为了优化范围查询，有的 B 族树将叶子节点存储时物理连续。但当数据不断插入时，维护此有序性的代价非常大。
4. 为叶子节点增加兄弟指针，以避免顺序遍历时的回溯。即 B+ 树的做法，但远不局限于 B+ 树。
5. B 树的变种，分形树，从 LSM-tree 借鉴了一些思想以优化 seek。
