## 数据集成

每一种软件，甚至所谓的通用数据库，都是针对特定的使用模式设计的。

在复杂的应用中，不太可能存在适用于所有不同数据应用场景的软件，因此不可避免的需要拼凑多个不同的软件来给应用提供所需的功能。



### 组合使用衍生系统的工具

为了处理任意关键词的组合搜索查询，可以将OLTP数据库和全文搜索引擎集成在一起。

数据集成系统随着数据不同表现形式的增加，数据的维护会越来越难。除了在数据库和搜索引擎之外，也许你需要在分析系统（数据仓库、批处理、流处理系统）中维护数据副本，需要维护从原始数据中衍生的缓存，或者反规范化的数据版本，需要将数据灌入机器学习、分类、排名或推荐系统中，或者基于数据变更发送通知。



### 理解数据流

哪些数据先写入，哪些数据表示衍生自哪些来源，这些问题。

允许应用程序直接写入记录系统和衍生系统，相当于是多主的数据集成系统，可能会有写入冲突问题。

另一种方式是首先将数据写入记录系统数据库，捕获对该数据库所做的变更（CDC），然后将变更以相同的顺序应用于其他衍生系统。如果写入数据库是向记录系统提供输入的唯一方式，其他衍生系统都是通过CDC派生。

基于事件日志来更新衍生数据的系统，不会有写入冲突问题，通常可以做到确定性和幂等性，使得从故障中恢复相当容易。

#### 衍生数据与分布式事务

保证不同数据系统的彼此一致的经典方法是分布式事务，分布式事务通过锁进行互斥来决定写入的顺序，而CDC基于排序的日志。分布式事务使用原子提交来确保变更只生效一次，但基于日志的系统通常基于确定性重试和幂等性。

最大的不同是事务系统通常提供线性一致性，可以保证读已之写，但衍生数据是异步更新的，它们不会提供相同的时序保证。

分布式事务有性能的瓶颈，基于日志的衍射数据是集成不同数据系统的最有前途的方法。如何在异步衍生系统上实现更强保证的方法非常重要。

#### 全序的限制

构建一个完全有序的事件日志在足够小的系统上是完全可行的，比如单主的数据库。但系统更大更复杂时，限制也增多了：

1. 单主的事件吞吐量有很低的上限；
2. 单主不能构建异地的数据中心；
3. 不能离线脱机工作；

在形式上，决定事件的全局顺序称为全序广播，相当于共识。大多共识算法都是针对单主的共识，针对于多个节点的共识算法还需要研究。

#### 排序事件以捕获因果关系

在事件之间不存在因果关系的情况下，全序的缺乏并不是一个大问题，因为并发事件可以任意排序。但因果关系非常有可能在外部出现，一个解决方法是给事件一个唯一的标识符，后面的任何事件都可以用该标识符来记录因果关系。
